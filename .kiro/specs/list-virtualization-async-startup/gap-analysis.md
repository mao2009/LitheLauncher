# Gap Analysis: List Virtualization and Async Startup

## 1. 現状分析 (Current State Investigation)

### 主要な資産と構造
- **MainWindow (`src/main_window.py`)**: `_load_games()` メソッドで全ゲームを一括ロードし、ウィジェットを生成して `FlowLayout` に追加しています。
- **GameService (`src/game_service.py`)**: `get_game_list()` で DB から全件取得します。同期処理です。
- **GameCardWidget (`src/game_card_widget.py`)**: 各ゲームを表示するウィジェット。画像読み込みは `ImageLoader` を使い非同期化されていますが、ウィジェット自体の生成はメインスレッドで行われます。
- **FlowLayout (`src/flow_layout.py`)**: カスタムレイアウトマネージャー。追加された全ウィジェットの座標計算を毎回行います。仮想化には対応していません。

### 既存のパターン
- **Service-Repository Pattern**: ビジネスロジックとデータアクセスが分離されています。
- **Async Pattern (Images)**: `QThreadPool` を用いた画像のバックグラウンド読み込み。
- **Callback/Signal Pattern**: サービスから UI への通知にシグナルが使われています。

---

## 2. 要件実現のフィジビリティ (Requirements Feasibility)

### 技術的ニーズ
- **非同期データロード**: DB クエリと初期ウィジェット生成の非同期化。
- **UI 仮想化**: 画面に表示されている範囲（ViewPort）のウィジェットのみを実体化する仕組み。
- **リサイクル機構**: スクロール時に画面外に出たウィジェットを破棄または再利用する仕組み。

### ギャップと制約
- **Missing**: 全件一括生成を行わない「段階的ロード」または「仮想リスト」の仕組みが現在ありません。
- **Constraint**: 現行の `FlowLayout` は全アイテムの `sizeHint` に依存してレイアウトを決定するため、仮想化（アイテムが存在しない状態でのスクロール位置計算）との相性が悪いです。
- **Research Needed**: 
    - `QListView` の `IconMode` と `FlowMode` が、現在の `GameCardWidget` の柔軟なスタイリングを維持できるか。
    - `FlowLayout` を維持したまま仮想化を実現するための、スクロール位置とインデックスのマッピング計算手法。

---

## 3. 実装アプローチのオプション (Implementation Options)

### オプション A: チャンク読み込みと非同期生成 (Extend)
**概要**: 既存の `FlowLayout` を維持しつつ、タイマーや `QThread` を用いてウィジェットを 20 個ずつなどの「チャンク」単位で追加します。
- **長所**: 既存コードへの変更が最小限。起動時のフリーズを即座に解消できる。
- **短所**: 最終的に 1000 個のウィジェットがメモリ上に残るため、メモリ使用量の根本解決にはならない。スクロールが重くなる可能性が残る。

### オプション B: QAbstractItemView への移行 (New Component)
**概要**: `QListView` と `QAbstractListModel` を使用します。
- **長所**: Qt 標準の仮想化機能を利用できる。メモリ効率が最高で、1 万件でも高速。
- **短所**: `GameCardWidget` を `QStyledItemDelegate` で再実装する必要があり、複雑な UI やマウスオーバーエフェクトの実装コストが高い。

### オプション C: 仮想化スクロールコンテナの実装 (Hybrid)
**概要**: `QScrollArea` のスクロールイベントを監視し、表示領域に該当するゲームのウィジェットのみを動的に `FlowLayout` へ追加・削除します。
- **長所**: 既存の `GameCardWidget` と `FlowLayout` の表現力を維持しつつ、メモリ負荷を抑えられる。
- **短所**: スクロールバーのサイズを正しく保つために、未生成アイテムのダミー領域（スペーサー）を計算するロジックが必要。

---

## 4. 実装の複雑さとリスク (Complexity & Risk)

- **工数**: **M (3–7 days)**
    - 非同期ロードの実装は容易だが、仮想化（特に FlowLayout との組み合わせ）のデバッグに時間を要する予想。
- **リスク**: **Medium**
    - リストの仮想化はスクロールの「ガタつき」を招きやすいため、スムーズな UX を維持するための調整が必要。

---

## 5. 設計フェーズへの推奨事項 (Recommendations)

1.  **優先アプローチ**: **オプション C (Hybrid)** を推奨。
    - 理由: `LitheLauncher` の洗練された UI（GameCardWidget のアニメーションや QSS スタイル）を損なわずに、スケーラビリティを確保できるため。
2.  **調査項目**:
    - `FlowLayout` 内でウィジェットを削除・挿入した際の再計算コストの検証。
    - スクロール位置から「現在何行目が見えているか」を高速に逆算するアルゴリズム。
3.  **フェーズ分割**:
    - フェーズ 1: 非同期データロードの実装（0.7 秒起動の達成）。
    - フェーズ 2: 段階的ウィジェット生成の実装。
    - フェーズ 3: 仮想化（画面外の破棄）によるメモリ最適化。
